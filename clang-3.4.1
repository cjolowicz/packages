#!/bin/bash

. $(dirname $0)/lib/main.sh

url=http://llvm.org/releases/$version/cfe-$version.src.tar.gz
dependencies+=(llvm-3.4.1 libedit-20140213-3.1)
configure_type=cmake

package_extra=clang-tools-extra
version_extra=3.4
file_extra=$package_extra-$version_extra.tar.gz
url_extra=http://llvm.org/releases/$version_extra/$file_extra

cmake_opts+=(
    -DCMAKE_PREFIX_PATH=$prefix
    -DCMAKE_INSTALL_PREFIX=$pkginstalldir
    -DCMAKE_BUILD_TYPE=Debug
    -DCLANG_PATH_TO_LLVM_BUILD=$builddir/llvm-$version
    -DCLANG_PATH_TO_LLVM_SOURCE=$srcdir/llvm-$version
    -DLLVM_EXTERNAL_CLANG_TOOLS_EXTRA_SOURCE_DIR=$srcdir/$package_extra-$version_extra
    )

do_source_extra() {
    cd $srcdir

    wget "${wget_opts[@]}" -O $file_extra $url_extra

    _extract $file_extra

    patch -p2 -d $package_extra-$version_extra <<EOF
--- clang-tools-extra/trunk/CMakeLists.txt (original)
+++ clang-tools-extra/trunk/CMakeLists.txt Sun Jan 19 02:54:11 2014
@@ -1,3 +1,16 @@
-check_library_exists(edit el_init "" HAVE_LIBEDIT)
+include(CheckLibraryExists)
+
+find_library(LIBEDIT_LIBRARY_FILE edit)
+if(LIBEDIT_LIBRARY_FILE)
+    get_filename_component(LIBEDIT_LIBRARY_DIRECTORY "\${LIBEDIT_LIBRARY_FILE}" PATH)
+    check_library_exists(edit el_init "\${LIBEDIT_LIBRARY_DIRECTORY}" HAVE_LIBEDIT)
+    link_directories("\${LIBEDIT_LIBRARY_DIRECTORY}")
+endif()
+
+find_file(LIBEDIT_INCLUDE_FILE histedit.h)
+if(LIBEDIT_INCLUDE_FILE)
+    get_filename_component(LIBEDIT_INCLUDE_DIRECTORY "\${LIBEDIT_INCLUDE_FILE}" PATH)
+    include_directories("\${LIBEDIT_INCLUDE_DIRECTORY}")
+endif()
 
 add_subdirectory(clang-apply-replacements)
EOF
}

do_source() {
    cd $srcdir

    wget "${wget_opts[@]}" -O $file $url

    _extract $file

    do_source_extra
}

main "$@"
