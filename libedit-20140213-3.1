#!/bin/bash -ex

packagedir=$HOME/sources/packages
srcdir=$HOME/sources/thirdparty
builddir=$HOME/build/thirdparty
installdir=$HOME/local/stow

### config ###########################################################

package=libedit
version=20140213-3.1
file=$package-$version.tar.gz
url=http://thrysoee.dk/editline/$file
dependencies=()
config=(--prefix $installdir/$package-$version)

### functions ########################################################

do_deps() {
    mkdir -p $packagedir

    for dependency in ${dependencies[@]} ; do
        $packagedir/$dependency
    done
}

do_source() {
    mkdir -p $srcdir

    cd $srcdir

    wget -O $file $url && tar zxf $file
}

do_configure() {
    [ -d $srcdir/$package-$version.src ] || do_source

    mkdir -p $builddir/$package-$version

    cd $builddir/$package-$version

    $srcdir/$package-$version/configure ${config[@]}
}

do_build() {
    [ -f $builddir/$package-$version/Makefile ] || do_configure

    cd $builddir/$package-$version

    make
}

do_stage() {
    [ -f $builddir/$package-$version/Makefile ] || do_build

    mkdir -p $installdir

    cd $builddir/$package-$version

    make install
}

do_install() {
    [ -d $installdir/$package-$version ] || do_stage

    cd $installdir

    stow $package-$version
}

### main #############################################################

[ $# -gt 0 ] || set -- install

for arg ; do
    case $arg in
        'deps')      do_deps      ;;
        'source')    do_source    ;;
        'configure') do_configure ;;
        'build')     do_build     ;;
        'stage')     do_stage     ;;
        'install')   do_install   ;;
    esac
done
