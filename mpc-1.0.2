#!/bin/bash

set -e

prog=$(basename $0)

### config ###########################################################

package=mpc
version=1.0.2

packagedir=$HOME/sources/packages

srcdir=$HOME/sources/thirdparty
builddir=$HOME/build/thirdparty
prefix=$HOME/local

installdir=$prefix/stow
libdir=$prefix/lib
includedir=$prefix/include
infodir=$prefix/share/info

pkgsrcdir=$srcdir/$package-$version
pkgbuilddir=$builddir/$package-$version
pkginstalldir=$installdir/$package-$version

file=$package-$version.tar.gz
baseurl=ftp://ftp.gnu.org/gnu
url=$baseurl/$package/$file

dependencies=(gmp-6.0.0 mpfr-3.1.2)
config=(--prefix $installdir/$package-$version)
env=(LDFLAGS=-L$libdir CPPFLAGS=-I$includedir)

### help #############################################################

do_help() {
    echo "$prog [deps|source|configure|build|stage|install].."
    exit
}

### deps #############################################################

do_deps() {
    for dependency in ${dependencies[@]} ; do
        $packagedir/$dependency install
    done
}

### source ###########################################################

do_source() {
    cd $srcdir

    wget -O $file $url && tar zxf $file
}

### configure ########################################################

do_configure() {
    [ -f $pkgsrcdir/configure ] || do_source

    mkdir -p $pkgbuilddir

    cd $pkgbuilddir

    env ${env[@]} $pkgsrcdir/configure ${config[@]}
}

### build ############################################################

do_build() {
    [ -f $pkgbuilddir/Makefile ] || do_configure

    cd $pkgbuilddir

    env ${env[@]} make
}

### stage ############################################################

do_stage() {
    [ -f $pkgbuilddir/Makefile ] || do_build

    mkdir -p $installdir

    cd $pkgbuilddir

    env ${env[@]} make install
}

### install ##########################################################

do_install() {
    [ -d $pkginstalldir ] || do_stage

    rm -f $infodir/dir

    cd $installdir

    stow $package-$version
}

### main #############################################################

[ $# -gt 0 ] || do_help

while [ $# -gt 0 ] ; do
    arg="$1"
    shift

    case $arg in
        'deps')      do_deps      ;;
        'source')    do_source    ;;
        'configure') do_configure ;;
        'build')     do_build     ;;
        'stage')     do_stage     ;;
        'install')   do_install   ;;
        *)           do_help      ;;
    esac
done
