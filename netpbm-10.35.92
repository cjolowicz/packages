#!/bin/bash -ex

. $(dirname $0)/lib/main.sh

url=http://sourceforge.net/projects/$package/files/super_stable/$version/$package-$version.tgz
dependencies+=(libjpeg-6b libtiff-4.0.3)
make_vars+=(pkgdir=$pkginstalldir)

do_configure() {
    [ -f $pkgsrcdir/Makefile.config.in ] || do_source

    mkdir -p $builddir

    cd $builddir

    ln -sf $pkgsrcdir

    cd $pkgbuilddir

    cat Makefile.config.in - > Makefile.config <<EOF
DEFAULT_TARGET = nonmerge
NETPBMLIBTYPE=unixshared
NETPBMLIBSUFFIX=so
STATICLIB_TOO=y
CFLAGS = -O3 -ffast-math  -pedantic -fno-common -Wall -Wno-uninitialized -Wmissing-declarations -Wimplicit -Wwrite-strings -Wmissing-prototypes -Wundef
CFLAGS_MERGE = -Wno-missing-declarations -Wno-missing-prototypes
LDRELOC = ld --reloc
LINKER_CAN_DO_EXPLICIT_LIBRARY=Y
LINKERISCOMPILER = Y
CFLAGS_SHLIB += -fPIC
TIFFLIB = $libdir/libtiff.a
TIFFHDR_DIR = $includedir
JPEGLIB = $libdir/libjpeg.a
JPEGHDR_DIR = $includedir
ZLIB = libz.so
X11LIB = libX11.so
NETPBM_DOCURL = http://netpbm.sourceforge.net/doc/
EOF
}

do_stage() {
    [ -f $pkgbuilddir/Makefile ] || do_build

    mkdir -p $installdir

    cd $pkgbuilddir

    make package "${env[@]}" "${make_vars[@]}"
}

main "$@"
