#!/bin/bash -ex

package=netpbm
version=10.35.92
file=$package-$version.tgz
url=http://sourceforge.net/projects/$package/files/super_stable/$version/$file/download
config=()
dependencies=(libjpeg-6b libtiff-4.0.3)

### main #############################################################

packagedir=$HOME/sources/packages
srcdir=$HOME/sources/thirdparty
builddir=$srcdir
installdir=$HOME/local/stow

mkdir -p $packagedir
mkdir -p $srcdir
mkdir -p $builddir/$package-$version
mkdir -p $installdir

for dependency in ${dependencies[@]} ; do
    $packagedir/$dependency
done

cd $srcdir
wget -O $file $url
tar zxf $file

cd $builddir/$package-$version
cat Makefile.config.in - > Makefile.config <<EOF
DEFAULT_TARGET = nonmerge
NETPBMLIBTYPE=unixshared
NETPBMLIBSUFFIX=so
STATICLIB_TOO=y
CFLAGS = -O3 -ffast-math  -pedantic -fno-common -Wall -Wno-uninitialized -Wmissing-declarations -Wimplicit -Wwrite-strings -Wmissing-prototypes -Wundef
CFLAGS_MERGE = -Wno-missing-declarations -Wno-missing-prototypes
LDRELOC = ld --reloc
LINKER_CAN_DO_EXPLICIT_LIBRARY=Y
LINKERISCOMPILER = Y
CFLAGS_SHLIB += -fPIC
TIFFLIB = $HOME/local/lib/libtiff.a
TIFFHDR_DIR = $HOME/local/include
JPEGLIB = $HOME/local/lib/libjpeg.a
JPEGHDR_DIR = $HOME/local/include
ZLIB = libz.so
X11LIB = libX11.so
NETPBM_DOCURL = http://netpbm.sourceforge.net/doc/
EOF
make
make package pkgdir=$installdir/$package-$version

cd $installdir
stow $package-$version
