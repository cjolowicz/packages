#!/bin/bash

set -e

prog=$(basename $0)

### config ###########################################################

package=gmp
version=6.0.0

packagedir=$HOME/sources/packages

srcdir=$HOME/sources/thirdparty
builddir=$HOME/build/thirdparty
installdir=$HOME/local/stow

pkgsrcdir=$srcdir/$package-$version
pkgbuilddir=$builddir/$package-$version
pkginstalldir=$installdir/$package-$version

file=$package-${version}a.tar.bz2
baseurl=https://gmplib.org/download
url=$baseurl/$package/$file

dependencies=()
config=(--prefix $installdir/$package-$version)

### help #############################################################

do_help() {
    echo "$prog [deps|source|configure|build|stage|install].."
    exit
}

### deps #############################################################

do_deps() {
    for dependency in ${dependencies[@]} ; do
        $packagedir/$dependency install
    done
}

### source ###########################################################

do_source() {
    cd $srcdir

    wget -O $file $url && tar jxf $file
}

### configure ########################################################

do_configure() {
    [ -f $pkgsrcdir/configure ] || do_source

    mkdir -p $pkgbuilddir

    cd $pkgbuilddir

    $pkgsrcdir/configure ${config[@]}
}

### build ############################################################

do_build() {
    [ -f $pkgbuilddir/Makefile ] || do_configure

    cd $pkgbuilddir

    make
}

### stage ############################################################

do_stage() {
    [ -f $pkgbuilddir/Makefile ] || do_build

    mkdir -p $installdir

    cd $pkgbuilddir

    make install
}

### install ##########################################################

do_install() {
    [ -d $pkginstalldir ] || do_stage

    cd $installdir

    stow $package-$version
}

### main #############################################################

[ $# -gt 0 ] || do_help

while [ $# -gt 0 ] ; do
    arg="$1"
    shift

    case $arg in
        'deps')      do_deps      ;;
        'source')    do_source    ;;
        'configure') do_configure ;;
        'build')     do_build     ;;
        'stage')     do_stage     ;;
        'install')   do_install   ;;
        *)           do_help      ;;
    esac
done
